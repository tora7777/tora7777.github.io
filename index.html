<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬å·¥å­¦é™¢è’²ç”°æ ¡ é¢æ¥ãƒ–ãƒ¼ã‚¹äºˆç´„ã‚·ã‚¹ãƒ†ãƒ  v2.0</title>
    <style>
        /* ============================================
           åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©
           ============================================ */
        :root {
            /* ã‚«ãƒ©ãƒ¼ãƒ†ãƒ¼ãƒå¤‰æ•° */
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --light-bg: #f0f2f5;
            --white: #ffffff;
            --text-primary: #333333;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            
            /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¤‰æ•° */
            --header-height: 60px;
            --container-width: 1200px;
            --card-padding: 2rem;
            --border-radius: 8px;
            
            /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            --transition-speed: 0.3s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Sans', 'Yu Gothic UI', Meiryo, sans-serif;
            background: var(--light-bg);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* ============================================
           ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹
           ============================================ */
        .container {
            max-width: var(--container-width);
            margin: 0 auto;
            padding: 20px;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--light-bg);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ============================================
           ãƒ˜ãƒƒãƒ€ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
           ============================================ */
        .header {
            background: var(--secondary-color);
            color: var(--white);
            height: var(--header-height);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 100;
        }

        .header-content {
            max-width: var(--container-width);
            margin: 0 auto;
            padding: 0 20px;
            height: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-color);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        /* ============================================
           ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
           ============================================ */
        .card {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: var(--card-padding);
            margin-bottom: 2rem;
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .card-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ============================================
           ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢
           ============================================ */
        .main-content {
            margin-top: calc(var(--header-height) + 20px);
            min-height: calc(100vh - var(--header-height) - 40px);
        }

        /* ============================================
           æ™‚é–“é¸æŠã‚°ãƒªãƒƒãƒ‰
           ============================================ */
        .time-slot-container {
            position: relative;
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: #fafafa;
        }

        .time-slot {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-speed);
            font-size: 0.875rem;
            background: var(--white);
        }

        .time-slot:hover:not(.unavailable) {
            border-color: var(--primary-color);
            background: #f0f8ff;
        }

        .time-slot.selected {
            background: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
            font-weight: bold;
        }

        .time-slot.unavailable {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        /* ============================================
           ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ 
           ============================================ */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color var(--transition-speed);
            background: var(--white);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* ============================================
           ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«
           ============================================ */
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: all var(--transition-speed);
            text-decoration: none;
            text-align: center;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::after {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--white);
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* ============================================
           ã‚¢ãƒ©ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ 
           ============================================ */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            position: relative;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* ============================================
           ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦
           ============================================ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: var(--white);
            margin: 5% auto;
            padding: 2rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: slideDown 0.3s ease-out;
            max-height: 80vh;
            overflow-y: auto;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* ============================================
           ãƒšãƒ¼ã‚¸å›ºæœ‰ã‚¹ã‚¿ã‚¤ãƒ«
           ============================================ */
        .page {
            display: none;
            animation: pageTransition 0.3s ease-out;
        }

        .page.active {
            display: block;
        }

        @keyframes pageTransition {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ============================================
           çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
           ============================================ */
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 0.5rem 0;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ============================================
           è‡ªå‹•å‰²ã‚Šå½“ã¦æƒ…å ±è¡¨ç¤º
           ============================================ */
        .auto-assign-info {
            background: #e8f4fd;
            border-left: 4px solid var(--primary-color);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }

        .auto-assign-info ul {
            padding-left: 1.5rem;
            margin: 0.5rem 0;
        }

        .auto-assign-info li {
            margin-bottom: 0.3rem;
        }

        /* ============================================
           ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³
           ============================================ */
        @media (max-width: 768px) {
            .header-content {
                padding: 0 10px;
            }

            .logo {
                font-size: 1.2rem;
            }

            .time-slots {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
                max-height: 200px;
            }

            .modal-content {
                margin: 10% auto;
                padding: 1.5rem;
            }

            .admin-stats {
                grid-template-columns: 1fr;
            }
            
            .stat-card {
                padding: 1rem;
            }
        }

        /* ============================================
           ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š
           ============================================ */
        :focus-visible {
            outline: 3px solid var(--primary-color);
            outline-offset: 2px;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* ============================================
           å°åˆ·ã‚¹ã‚¿ã‚¤ãƒ«
           ============================================ */
        @media print {
            .header, .btn, .modal {
                display: none !important;
            }

            .main-content {
                margin-top: 0;
            }

            .card {
                box-shadow: none;
                border: 1px solid #000;
            }
        }
    </style>
</head>
<body>
    <!-- ============================================
         ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ§‹é€ 
         ============================================ -->
    
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <header class="header hidden" id="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">ğŸ¢</div>
                <span>é¢æ¥ãƒ–ãƒ¼ã‚¹äºˆç´„ã‚·ã‚¹ãƒ†ãƒ </span>
            </div>
            <nav>
                <ul class="nav-menu" style="list-style: none; display: flex; gap: 20px;">
                    <li><a href="#" onclick="NavigationController.navigateTo('reservation')" class="nav-link" style="color: white; text-decoration: none;">äºˆç´„</a></li>
                    <li><a href="#" onclick="NavigationController.navigateTo('management')" class="nav-link" style="color: white; text-decoration: none;">äºˆç´„ç®¡ç†</a></li>
                    <li class="hidden" id="adminLink"><a href="#" onclick="NavigationController.navigateTo('admin')" class="nav-link" style="color: white; text-decoration: none;">ç®¡ç†è€…</a></li>
                </ul>
            </nav>
            <div class="user-info" style="display: flex; align-items: center; gap: 10px; color: white;">
                <span id="userEmail"></span>
                <button class="btn btn-secondary" onclick="AuthController.logout()" style="background: #95a5a6; color: white;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="main-content">
        
        <!-- ============================================
             ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
             ============================================ -->
        <div class="page active" id="loginPage">
            <div class="container" style="max-width: 400px; margin-top: 100px;">
                <div class="card">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <h1 style="color: var(--secondary-color); font-size: 2rem;">é¢æ¥ãƒ–ãƒ¼ã‚¹äºˆç´„ã‚·ã‚¹ãƒ†ãƒ </h1>
                        <p style="color: var(--text-secondary);">æ—¥æœ¬å·¥å­¦é™¢è’²ç”°æ ¡ å­¦ç”Ÿå°‚ç”¨</p>
                    </div>
                    
                    <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
                    <div id="loginForm">
                        <form onsubmit="AuthController.handleLogin(event)">
                            <div class="form-group">
                                <label for="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                <input type="email" id="email" placeholder="k000a0000@g.neec.ac.jp" required>
                            </div>
                            <div class="form-group">
                                <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                                <input type="password" id="password" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%">ãƒ­ã‚°ã‚¤ãƒ³</button>
                        </form>
                        <div style="text-align: center; margin-top: 1rem;">
                            <a href="#" onclick="AuthController.showRegisterForm()" style="color: var(--primary-color);">åˆå›åˆ©ç”¨ã®æ–¹ã¯ã“ã¡ã‚‰</a>
                        </div>
                    </div>

                    <!-- æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
                    <div id="registerForm" class="hidden">
                        <form onsubmit="AuthController.handleRegister(event)">
                            <div class="form-group">
                                <label for="regEmail">å­¦æ ¡ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                <input type="email" id="regEmail" placeholder="k000a0000@g.neec.ac.jp" 
                                       pattern="k[0-9]{3}[a-z][0-9]{4}@g\.neec\.ac\.jp" required>
                            </div>
                            <div class="form-group">
                                <label for="regPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                                <input type="password" id="regPassword" minlength="8" required>
                            </div>
                            <div class="form-group">
                                <label for="regPasswordConfirm">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
                                <input type="password" id="regPasswordConfirm" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%">ç™»éŒ²</button>
                        </form>
                        <div style="text-align: center; margin-top: 1rem;">
                            <a href="#" onclick="AuthController.showLoginForm()" style="color: var(--primary-color);">ãƒ­ã‚°ã‚¤ãƒ³ã«æˆ»ã‚‹</a>
                        </div>
                    </div>

                    <!-- ãƒ¡ãƒ¼ãƒ«èªè¨¼ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ -->
                    <div id="verificationMessage" class="hidden" style="margin-top: 1.5rem; text-align: center;">
                        <div class="alert alert-info">èªè¨¼ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚</div>
                        <p>ãƒ‡ãƒ¢ã®ãŸã‚ã€ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã§èªè¨¼ã‚’å®Œäº†ã§ãã¾ã™ã€‚</p>
                        <button class="btn btn-success" id="verifyButton" style="background-color: var(--success-color);">ä»Šã™ãèªè¨¼ã™ã‚‹</button>
                    </div>

                </div>
            </div>
        </div>

        <!-- ============================================
             äºˆç´„ãƒšãƒ¼ã‚¸
             ============================================ -->
        <div class="page" id="reservationPage">
            <div class="container">
                <div class="card">
                    <h2 class="card-header">
                        <span>ğŸ“…</span>
                        æ–°è¦äºˆç´„
                    </h2>
                    
                    <div class="auto-assign-info">
                        <p><strong>ãƒ–ãƒ¼ã‚¹è‡ªå‹•å‰²ã‚Šå½“ã¦ã‚·ã‚¹ãƒ†ãƒ ã«ã¤ã„ã¦</strong></p>
                        <p>ã‚·ã‚¹ãƒ†ãƒ ãŒä»¥ä¸‹ã®å„ªå…ˆé †ä½ã§è‡ªå‹•çš„ã«ãƒ–ãƒ¼ã‚¹ã‚’å‰²ã‚Šå½“ã¦ã¾ã™ï¼š</p>
                        <ul>
                            <li>1. æ‰€å±ã‚«ãƒ¬ãƒƒã‚¸ã®å°‚ç”¨ãƒ–ãƒ¼ã‚¹</li>
                            <li>2. å…±é€šåˆ©ç”¨ãƒ–ãƒ¼ã‚¹ï¼ˆ6,7ç•ªï¼‰</li>
                            <li>3. ä½¿ç”¨ç‡ã®ä½ã„ä»–ã‚«ãƒ¬ãƒƒã‚¸ãƒ–ãƒ¼ã‚¹</li>
                        </ul>
                        <p>â€»ä»–ã‚«ãƒ¬ãƒƒã‚¸ã®ãƒ–ãƒ¼ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã¯ã€è©²å½“ã‚«ãƒ¬ãƒƒã‚¸ã®æ‹…å½“è€…ã«é€šçŸ¥ãŒé€ä¿¡ã•ã‚Œã¾ã™</p>
                    </div>
                    
                    <form onsubmit="ReservationController.handleReservation(event)">
                        <!-- æ—¥ä»˜é¸æŠ -->
                        <div class="form-group">
                            <label for="reservationDate">äºˆç´„æ—¥</label>
                            <input type="date" id="reservationDate" required onchange="ReservationController.updateAvailability()">
                        </div>

                        <!-- æ™‚é–“é¸æŠ -->
                        <div class="form-group">
                            <label>é–‹å§‹æ™‚é–“</label>
                            <div class="time-slot-container">
                                <div class="time-slots" id="timeSlots">
                                    <!-- å‹•çš„ç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>

                        <!-- åˆ©ç”¨æ™‚é–“ -->
                        <div class="form-group">
                            <label for="duration">åˆ©ç”¨æ™‚é–“</label>
                            <select id="duration">
                                <option value="30">30åˆ†</option>
                                <option value="60" selected>60åˆ†ï¼ˆæ¨™æº–ï¼‰</option>
                                <option value="90">90åˆ†</option>
                                <option value="120">120åˆ†</option>
                            </select>
                        </div>

                        <!-- åˆ©ç”¨ç›®çš„ -->
                        <div class="form-group">
                            <label for="purpose">åˆ©ç”¨ç›®çš„ãƒ»å‚™è€ƒ</label>
                            <textarea id="purpose" rows="3" placeholder="é¢æ¥ã®ç¨®é¡ã€ä¼æ¥­åãªã©"></textarea>
                        </div>

                        <!-- ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ -->
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="reminder" style="width: auto;"> 
                                äºˆç´„1æ™‚é–“å‰ã«ãƒªãƒã‚¤ãƒ³ãƒ‰ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹
                            </label>
                        </div>

                        <button type="submit" class="btn btn-primary">äºˆç´„ç¢ºå®š</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- ============================================
             äºˆç´„ç®¡ç†ãƒšãƒ¼ã‚¸
             ============================================ -->
        <div class="page" id="managementPage">
            <div class="container">
                <div class="card">
                    <h2 class="card-header">
                        <span>ğŸ“‹</span>
                        äºˆç´„ç®¡ç†
                    </h2>
                    <div id="userReservations">
                        <!-- å‹•çš„ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================
             ç®¡ç†è€…ãƒšãƒ¼ã‚¸
             ============================================ -->
        <div class="page" id="adminPage">
            <div class="container">
                <div class="card">
                    <h2 class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span>âš™ï¸</span>
                            ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                        </div>
                         <button class="btn btn-primary" onclick="AdminControllerInstance.openAddModal()">æ–°è¦äºˆç´„ä½œæˆ</button>
                    </h2>
                    
                    <!-- çµ±è¨ˆæƒ…å ± -->
                    <div class="admin-stats">
                        <div class="stat-card">
                            <div class="stat-label">æœ¬æ—¥ã®äºˆç´„</div>
                            <div class="stat-number" id="totalReservations">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
                            <div class="stat-number" id="totalUsers">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">ç¨¼åƒç‡</div>
                            <div class="stat-number" id="utilizationRate">0%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">åˆ©ç”¨å¯èƒ½ãƒ–ãƒ¼ã‚¹</div>
                            <div class="stat-number" id="activeBooths">7</div>
                        </div>
                    </div>

                    <!-- äºˆç´„ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
                    <h3 style="margin-top: 2rem; margin-bottom: 1rem;">å…¨äºˆç´„ä¸€è¦§</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color);">äºˆç´„ID</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color);">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color);">ãƒ–ãƒ¼ã‚¹</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color);">æ—¥æ™‚</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color);">æ™‚é–“</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color);">ã‚«ãƒ¬ãƒƒã‚¸</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color);">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="adminReservationsList">
                                <!-- å‹•çš„ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ============================================
         ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦
         ============================================ -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 1.5rem;">äºˆç´„ç¢ºèª</h2>
            <div id="confirmDetails"></div>
            <div style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-secondary" onclick="ModalController.closeModal('confirmModal')" style="background: #95a5a6; color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="ReservationController.confirmReservation()">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†è€…ç”¨ äºˆç´„è¿½åŠ ãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="adminAddEditModal" class="modal">
        <div class="modal-content">
            <h2 id="adminModalTitle" style="margin-bottom: 1.5rem;">æ–°è¦äºˆç´„ä½œæˆ</h2>
            <form id="adminReservationForm" onsubmit="AdminControllerInstance.saveReservation(event)">
                <input type="hidden" id="adminReservationId">
                <div class="form-group">
                    <label for="adminStudentEmail">å­¦ç”Ÿãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="adminStudentEmail" required>
                </div>
                <div class="form-group">
                    <label for="adminDate">æ—¥ä»˜</label>
                    <input type="date" id="adminDate" required>
                </div>
                <div class="form-group">
                    <label for="adminTime">é–‹å§‹æ™‚é–“</label>
                    <input type="time" id="adminTime" step="600" required>
                </div>
                <div class="form-group">
                    <label for="adminDuration">åˆ©ç”¨æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
                    <input type="number" id="adminDuration" value="60" step="10" required>
                </div>
                <div class="form-group">
                    <label for="adminBoothId">ãƒ–ãƒ¼ã‚¹</label>
                    <select id="adminBoothId" required>
                        <!-- AppConfigã‹ã‚‰å‹•çš„ã«ç”Ÿæˆ -->
                    </select>
                </div>
                 <div class="form-group">
                    <label for="adminPurpose">ç›®çš„</label>
                    <textarea id="adminPurpose" rows="2"></textarea>
                </div>
                <div style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="ModalController.closeModal('adminAddEditModal')" style="background: #95a5a6; color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>


    <!-- ============================================
         JavaScriptãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
         ============================================ -->
    <script>
        'use strict';

        /**
         * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
         * ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®è¨­å®šå€¤ã‚’ç®¡ç†
         */
        const AppConfig = {
            collegeMap: {
                'c': { name: 'ITã‚«ãƒ¬ãƒƒã‚¸' },
                'a': { name: 'ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã‚ºã‚«ãƒ¬ãƒƒã‚¸' },
                'b': { name: 'ãƒŸãƒ¥ãƒ¼ã‚¸ãƒƒã‚¯ã‚«ãƒ¬ãƒƒã‚¸' },
                'd': { name: 'ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚«ãƒ¬ãƒƒã‚¸' },
                'g': { name: 'ãƒ‡ã‚¶ã‚¤ãƒ³ã‚«ãƒ¬ãƒƒã‚¸' }
            },
            booths: [
                { id: 1, name: 'ãƒ–ãƒ¼ã‚¹1', college: 'd', collegeName: 'ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚«ãƒ¬ãƒƒã‚¸' },
                { id: 2, name: 'ãƒ–ãƒ¼ã‚¹2', college: 'c', collegeName: 'ITã‚«ãƒ¬ãƒƒã‚¸' },
                { id: 3, name: 'ãƒ–ãƒ¼ã‚¹3', college: 'a', collegeName: 'ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã‚ºã‚«ãƒ¬ãƒƒã‚¸' },
                { id: 4, name: 'ãƒ–ãƒ¼ã‚¹4', college: 'g', collegeName: 'ãƒ‡ã‚¶ã‚¤ãƒ³ã‚«ãƒ¬ãƒƒã‚¸' },
                { id: 5, name: 'ãƒ–ãƒ¼ã‚¹5', college: 'b', collegeName: 'ãƒŸãƒ¥ãƒ¼ã‚¸ãƒƒã‚¯ã‚«ãƒ¬ãƒƒã‚¸' },
                { id: 6, name: 'ãƒ–ãƒ¼ã‚¹6', college: 'common', collegeName: 'å…±é€šåˆ©ç”¨' },
                { id: 7, name: 'ãƒ–ãƒ¼ã‚¹7', college: 'common', collegeName: 'å…±é€šåˆ©ç”¨' }
            ],
            businessHours: {
                start: 9,
                end: 17,
                slotDuration: 10
            },
            adminUsers: [
                'admin@g.neec.ac.jp', // Example admin
            ],
            emailConfig: {
                domain: '@g.neec.ac.jp',
                pattern: /^k[0-9]{3}[a-z][0-9]{4}@g\.neec\.ac\.jp$/
            }
        };

        /**
         * ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
         * LocalStorageã‚’ä½¿ç”¨ã—ãŸãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–å±¤
         */
        class DataStorage {
            constructor() {
                this.storagePrefix = 'reservation_system_';
            }
            save(key, value) {
                try {
                    localStorage.setItem(this.storagePrefix + key, JSON.stringify(value));
                    return true;
                } catch (error) {
                    console.error('Storage save error:', error);
                    return false;
                }
            }
            load(key, defaultValue = null) {
                try {
                    const item = localStorage.getItem(this.storagePrefix + key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (error) {
                    console.error('Storage load error:', error);
                    return defaultValue;
                }
            }
        }

        /**
         * èªè¨¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
         * ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
         */
        class AuthenticationController {
            constructor(storage) {
                this.storage = storage;
                this.currentUser = null;
                this.users = this.storage.load('users', []);
            }

            initialize() {
                const savedUser = this.storage.load('currentUser');
                if (savedUser) {
                    this.currentUser = savedUser;
                    this.showLoggedInState();
                }
            }

            handleLogin(event) {
                event.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                const user = this.users.find(u => u.email === email);

                if (!user) {
                    NotificationService.show('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }

                if (user.password !== password) { // In a real app, use hashed passwords
                    NotificationService.show('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }

                if (!user.verified) {
                    NotificationService.show('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒèªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');
                    return;
                }

                const studentId = email.split('@')[0];
                const collegeChar = studentId.charAt(4);
                const userCollege = AppConfig.collegeMap[collegeChar];
                const isAdmin = AppConfig.adminUsers.includes(email);

                this.currentUser = {
                    email: email,
                    studentId: studentId,
                    college: collegeChar,
                    collegeName: userCollege ? userCollege.name : 'ä¸æ˜',
                    isAdmin: isAdmin,
                };

                this.storage.save('currentUser', this.currentUser);
                this.showLoggedInState();
                NotificationService.show('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ', 'success');
            }

            handleRegister(event) {
                event.preventDefault();
                const email = document.getElementById('regEmail').value;
                const password = document.getElementById('regPassword').value;
                const passwordConfirm = document.getElementById('regPasswordConfirm').value;

                if (!AppConfig.emailConfig.pattern.test(email)) {
                    NotificationService.show('å­¦æ ¡æŒ‡å®šã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                if (password !== passwordConfirm) {
                    NotificationService.show('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“', 'error');
                    return;
                }
                if (this.users.some(u => u.email === email)) {
                    NotificationService.show('ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™', 'error');
                    return;
                }

                const studentId = email.split('@')[0];
                const collegeChar = studentId.charAt(4);
                const userCollege = AppConfig.collegeMap[collegeChar];

                const newUser = {
                    email: email,
                    password: password, // In a real app, hash this
                    studentId: studentId,
                    college: collegeChar,
                    collegeName: userCollege ? userCollege.name : 'ä¸æ˜',
                    verified: false
                };
                
                this.users.push(newUser);
                this.storage.save('users', this.users);

                document.getElementById('registerForm').classList.add('hidden');
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('verificationMessage').classList.remove('hidden');
                
                const verifyButton = document.getElementById('verifyButton');
                verifyButton.onclick = () => this.verifyUser(email);
            }

            verifyUser(email) {
                const user = this.users.find(u => u.email === email);
                if (user) {
                    user.verified = true;
                    this.storage.save('users', this.users);
                    NotificationService.show('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒèªè¨¼ã•ã‚Œã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'success');
                    document.getElementById('verificationMessage').classList.add('hidden');
                    this.showLoginForm();
                }
            }

            showLoggedInState() {
                document.getElementById('header').classList.remove('hidden');
                document.getElementById('userEmail').textContent = this.currentUser.studentId;
                
                if (this.currentUser.isAdmin) {
                    document.getElementById('adminLink').classList.remove('hidden');
                }
                
                NavigationController.navigateTo('reservation');
                ReservationController.initialize();
            }

            logout() {
                if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                    this.storage.save('currentUser', null);
                    this.currentUser = null;
                    document.getElementById('header').classList.add('hidden');
                    NavigationController.navigateTo('login');
                    NotificationService.show('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'success');
                }
            }

            showRegisterForm() {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('verificationMessage').classList.add('hidden');
                document.getElementById('registerForm').classList.remove('hidden');
            }

            showLoginForm() {
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('verificationMessage').classList.add('hidden');
                document.getElementById('registerForm').classList.add('hidden');
            }

            getCurrentUser() {
                return this.currentUser;
            }
        }
        
        /**
         * äºˆç´„ç®¡ç†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
         * äºˆç´„ã®ä½œæˆã€æ›´æ–°ã€å‰Šé™¤ã‚’ç®¡ç†
         */
        class ReservationManagementController {
            constructor(storage) {
                this.storage = storage;
                this.selectedTime = null;
                this.pendingReservation = null;
                this.reservations = [];
            }

            initialize() {
                this.loadReservations();
                this.renderTimeSlots();
                this.setDateConstraints();
            }

            loadReservations() {
                this.reservations = this.storage.load('reservations', []);
            }

            setDateConstraints() {
                const dateInput = document.getElementById('reservationDate');
                if (dateInput) {
                    const today = new Date();
                    const maxDate = new Date();
                    maxDate.setMonth(maxDate.getMonth() + 3);
                    
                    dateInput.min = today.toISOString().split('T')[0];
                    dateInput.max = maxDate.toISOString().split('T')[0];
                }
            }

            renderTimeSlots() {
                const container = document.getElementById('timeSlots');
                if (!container) return;

                const slots = [];
                const { start, end, slotDuration } = AppConfig.businessHours;
                
                for (let hour = start; hour < end; hour++) {
                    for (let min = 0; min < 60; min += slotDuration) {
                        const time = `${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
                        slots.push(time);
                    }
                }

                container.innerHTML = slots.map(time => `
                    <div class="time-slot" 
                         onclick="ReservationController.selectTime('${time}')"
                         data-time="${time}">
                        ${time}
                    </div>
                `).join('');
            }

            selectTime(time) {
                document.querySelectorAll('.time-slot').forEach(slot => slot.classList.remove('selected'));
                const selectedSlot = document.querySelector(`[data-time="${time}"]`);
                if (selectedSlot && !selectedSlot.classList.contains('unavailable')) {
                    selectedSlot.classList.add('selected');
                    this.selectedTime = time;
                }
            }

            updateAvailability() {
                const date = document.getElementById('reservationDate').value;
                if (!date) return;

                document.querySelectorAll('.time-slot').forEach(slot => {
                    slot.classList.remove('unavailable', 'selected');
                });
                this.selectedTime = null;

                const allBookedSlots = this.reservations
                    .filter(r => r.date === date)
                    .flatMap(r => {
                        const booked = [];
                        const [startHour, startMin] = r.startTime.split(':').map(Number);
                        const startMinutes = startHour * 60 + startMin;
                        
                        for (let i = 0; i < r.duration; i += AppConfig.businessHours.slotDuration) {
                            const slotMinutes = startMinutes + i;
                            const hour = Math.floor(slotMinutes / 60);
                            const min = slotMinutes % 60;
                            booked.push({
                                time: `${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`,
                                boothId: r.boothId
                            });
                        }
                        return booked;
                    });
                
                const bookedCountByTime = allBookedSlots.reduce((acc, slot) => {
                    acc[slot.time] = (acc[slot.time] || 0) + 1;
                    return acc;
                }, {});

                Object.entries(bookedCountByTime).forEach(([time, count]) => {
                     if (count >= AppConfig.booths.length) {
                        const slotEl = document.querySelector(`[data-time="${time}"]`);
                        if (slotEl) {
                            slotEl.classList.add('unavailable');
                        }
                     }
                });
            }

            assignBooth(date, startTime, duration) {
                const currentUser = AuthController.getCurrentUser();
                if (!currentUser) return null;
                
                const [startHour, startMin] = startTime.split(':').map(Number);
                const startMinutes = startHour * 60 + startMin;
                const endMinutes = startMinutes + duration;

                const checkAvailability = (booth) => {
                    return !this.reservations.some(reservation => {
                        if (reservation.date !== date || reservation.boothId !== booth.id) return false;
                        const [resStartHour, resStartMin] = reservation.startTime.split(':').map(Number);
                        const resStartMinutes = resStartHour * 60 + resStartMin;
                        const resEndMinutes = resStartMinutes + reservation.duration;
                        return (startMinutes < resEndMinutes && endMinutes > resStartMinutes);
                    });
                };
                
                const boothGroups = { ownCollege: [], common: [], otherCollege: [] };
                
                const boothReservationCounts = AppConfig.booths.reduce((acc, booth) => {
                    acc[booth.id] = this.reservations.filter(r => r.boothId === booth.id).length;
                    return acc;
                }, {});

                AppConfig.booths.forEach(booth => {
                    if (!checkAvailability(booth)) return;
                    
                    const boothWithCount = { ...booth, reservationCount: boothReservationCounts[booth.id] };

                    if (booth.college === currentUser.college) {
                        boothGroups.ownCollege.push(boothWithCount);
                    } else if (booth.college === 'common') {
                        boothGroups.common.push(boothWithCount);
                    } else {
                        boothGroups.otherCollege.push(boothWithCount);
                    }
                });
                
                boothGroups.ownCollege.sort((a, b) => a.reservationCount - b.reservationCount);
                boothGroups.common.sort((a, b) => a.reservationCount - b.reservationCount);
                boothGroups.otherCollege.sort((a, b) => a.reservationCount - b.reservationCount);
                
                return boothGroups.ownCollege[0] || boothGroups.common[0] || boothGroups.otherCollege[0] || null;
            }

            handleReservation(event) {
                event.preventDefault();
                if (!this.selectedTime) {
                    NotificationService.show('æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                    return;
                }

                const date = document.getElementById('reservationDate').value;
                const duration = parseInt(document.getElementById('duration').value);
                const purpose = document.getElementById('purpose').value;
                const reminder = document.getElementById('reminder').checked;
                const currentUser = AuthController.getCurrentUser();
                
                const assignedBooth = this.assignBooth(date, this.selectedTime, duration);
                
                if (!assignedBooth) {
                    NotificationService.show('é¸æŠã—ãŸæ™‚é–“å¸¯ã«åˆ©ç”¨å¯èƒ½ãªãƒ–ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }

                const isOtherCollege = assignedBooth.college !== currentUser.college && assignedBooth.college !== 'common';

                this.pendingReservation = {
                    id: `RES-${Date.now()}-${Math.floor(Math.random() * 1000)}`,
                    studentId: currentUser.studentId,
                    email: currentUser.email,
                    boothId: assignedBooth.id,
                    boothName: assignedBooth.name,
                    collegeName: assignedBooth.collegeName,
                    date: date,
                    startTime: this.selectedTime,
                    duration: duration,
                    purpose: purpose,
                    reminder: reminder,
                    isOtherCollege: isOtherCollege,
                    createdAt: new Date().toISOString(),
                    status: 'confirmed'
                };

                ModalController.showConfirmModal(this.pendingReservation);
            }

            confirmReservation() {
                if (!this.pendingReservation) return;

                this.reservations.push(this.pendingReservation);
                this.storage.save('reservations', this.reservations);

                console.log('äºˆç´„ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡:', { to: this.pendingReservation.email });
                if (this.pendingReservation.isOtherCollege) {
                    console.log('Slacké€šçŸ¥é€ä¿¡:', { channel: `#${this.pendingReservation.collegeName}` });
                }

                ModalController.closeModal('confirmModal');
                NotificationService.show('äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
                this.resetReservationForm();
            }

            resetReservationForm() {
                document.getElementById('reservationDate').value = '';
                document.getElementById('purpose').value = '';
                document.getElementById('reminder').checked = false;
                this.selectedTime = null;
                this.pendingReservation = null;
                this.renderTimeSlots();
            }

            loadUserReservations() {
                const container = document.getElementById('userReservations');
                const currentUser = AuthController.getCurrentUser();
                if (!currentUser) return;

                const userReservations = this.reservations
                    .filter(r => r.email === currentUser.email)
                    .sort((a, b) => new Date(`${a.date}T${a.startTime}`) - new Date(`${b.date}T${b.startTime}`));
                
                if (userReservations.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                container.innerHTML = userReservations.map(res => {
                    const isPast = new Date(`${res.date}T${res.startTime}`) < new Date();
                    return `
                        <div class="reservation-item" style="border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 1rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; ${isPast ? 'opacity: 0.6;' : ''}">
                            <div>
                                <h4 style="margin-bottom: 0.5rem;">${res.date} ${res.startTime} ${isPast ? ' (çµ‚äº†)' : ''}</h4>
                                <p>ãƒ–ãƒ¼ã‚¹: ${res.boothName}</p>
                                <p>æ™‚é–“: ${res.duration}åˆ†</p>
                            </div>
                            <div>
                                ${!isPast ? `<button class="btn btn-danger" onclick="ReservationController.cancelReservation('${res.id}')" style="background: var(--danger-color); color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            cancelReservation(reservationId) {
                if (!confirm('äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) return;
                const index = this.reservations.findIndex(r => r.id === reservationId);
                if (index === -1) return;
                const canceled = this.reservations[index];
                this.reservations.splice(index, 1);
                this.storage.save('reservations', this.reservations);
                console.log('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ¡ãƒ¼ãƒ«é€ä¿¡:', { to: canceled.email });
                NotificationService.show('äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ', 'success');
                this.loadUserReservations();
            }
        }

        /**
         * ç®¡ç†è€…ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
         */
        class AdminController {
            constructor(storage) {
                this.storage = storage;
            }

            loadAdminData() {
                this.updateStatistics();
                this.loadAllReservations();
                this.populateBoothSelector();
            }
            
            populateBoothSelector() {
                const select = document.getElementById('adminBoothId');
                select.innerHTML = AppConfig.booths.map(b => `<option value="${b.id}">${b.name} (${b.collegeName})</option>`).join('');
            }
            
            updateStatistics() {
                const reservations = this.storage.load('reservations', []);
                const users = this.storage.load('users', []);
                const today = new Date().toISOString().split('T')[0];
                
                document.getElementById('totalReservations').textContent = reservations.filter(r => r.date === today).length;
                document.getElementById('totalUsers').textContent = users.length;
                
                const totalSlots = AppConfig.booths.length * (AppConfig.businessHours.end - AppConfig.businessHours.start) * (60 / AppConfig.businessHours.slotDuration);
                const bookedSlots = reservations.filter(r => r.date === today).reduce((sum, r) => sum + (r.duration / AppConfig.businessHours.slotDuration), 0);
                document.getElementById('utilizationRate').textContent = `${totalSlots > 0 ? Math.round((bookedSlots / totalSlots) * 100) : 0}%`;
                document.getElementById('activeBooths').textContent = AppConfig.booths.length;
            }

            loadAllReservations() {
                const reservations = this.storage.load('reservations', []);
                const tbody = document.getElementById('adminReservationsList');
                
                if (reservations.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">äºˆç´„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                    return;
                }

                tbody.innerHTML = reservations.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).map(res => `
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 0.75rem;">${res.id.substring(4, 10)}...</td>
                        <td style="padding: 0.75rem;">${res.email}</td>
                        <td style="padding: 0.75rem;">${res.boothName}</td>
                        <td style="padding: 0.75rem;">${res.date}</td>
                        <td style="padding: 0.75rem;">${res.startTime} (${res.duration}åˆ†)</td>
                        <td style="padding: 0.75rem;">${res.collegeName}</td>
                        <td style="padding: 0.75rem; display: flex; gap: 5px;">
                            <button onclick="AdminControllerInstance.openEditModal('${res.id}')" style="background: #f39c12; color: white; border:none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">ç·¨é›†</button>
                            <button onclick="AdminControllerInstance.adminCancelReservation('${res.id}')" style="background: var(--danger-color); color: white; border:none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">å‰Šé™¤</button>
                        </td>
                    </tr>
                `).join('');
            }
            
            openAddModal() {
                document.getElementById('adminReservationForm').reset();
                document.getElementById('adminReservationId').value = '';
                document.getElementById('adminModalTitle').textContent = 'æ–°è¦äºˆç´„ä½œæˆ';
                ModalController.openModal('adminAddEditModal');
            }

            openEditModal(reservationId) {
                const reservations = this.storage.load('reservations', []);
                const reservation = reservations.find(r => r.id === reservationId);
                if (!reservation) return;

                document.getElementById('adminReservationId').value = reservation.id;
                document.getElementById('adminStudentEmail').value = reservation.email;
                document.getElementById('adminDate').value = reservation.date;
                document.getElementById('adminTime').value = reservation.startTime;
                document.getElementById('adminDuration').value = reservation.duration;
                document.getElementById('adminBoothId').value = reservation.boothId;
                document.getElementById('adminPurpose').value = reservation.purpose || '';
                document.getElementById('adminModalTitle').textContent = 'äºˆç´„ç·¨é›†';
                ModalController.openModal('adminAddEditModal');
            }

            saveReservation(event) {
                event.preventDefault();
                const reservations = this.storage.load('reservations', []);
                const users = this.storage.load('users', []);

                const id = document.getElementById('adminReservationId').value;
                const email = document.getElementById('adminStudentEmail').value;
                const date = document.getElementById('adminDate').value;
                const startTime = document.getElementById('adminTime').value;
                const duration = parseInt(document.getElementById('adminDuration').value);
                const boothId = parseInt(document.getElementById('adminBoothId').value);
                const purpose = document.getElementById('adminPurpose').value;

                if (!users.some(u => u.email === email)) {
                    NotificationService.show('æŒ‡å®šã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å­˜åœ¨ã—ã¾ã›ã‚“', 'error');
                    return;
                }
                
                const booth = AppConfig.booths.find(b => b.id === boothId);
                
                if (id) { // Edit existing
                    const index = reservations.findIndex(r => r.id === id);
                    if (index !== -1) {
                        reservations[index] = { ...reservations[index], email, date, startTime, duration, boothId, purpose, boothName: booth.name, collegeName: booth.collegeName };
                    }
                } else { // Add new
                    const studentId = email.split('@')[0];
                    reservations.push({
                        id: `RES-${Date.now()}-${Math.floor(Math.random() * 1000)}`,
                        email, studentId, date, startTime, duration, boothId, purpose,
                        boothName: booth.name, collegeName: booth.collegeName,
                        createdAt: new Date().toISOString()
                    });
                }
                
                this.storage.save('reservations', reservations);
                NotificationService.show('äºˆç´„æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
                ModalController.closeModal('adminAddEditModal');
                this.loadAdminData();
            }


            adminCancelReservation(reservationId) {
                if (!confirm('ã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
                let reservations = this.storage.load('reservations', []);
                const canceled = reservations.find(r => r.id === reservationId);
                reservations = reservations.filter(r => r.id !== reservationId);
                this.storage.save('reservations', reservations);
                console.log('ç®¡ç†è€…å‰Šé™¤é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡:', { to: canceled.email });
                NotificationService.show('äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                this.loadAdminData();
            }
        }

        /**
         * ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
         */
        const NavigationController = {
            navigateTo(pageName) {
                document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                const targetPage = document.getElementById(pageName + 'Page');
                if (targetPage) targetPage.classList.add('active');
                this.updateNavigation(pageName);
                this.handlePageLoad(pageName);
            },
            updateNavigation(pageName) {
                // ... (UI update logic)
            },
            handlePageLoad(pageName) {
                switch (pageName) {
                    case 'reservation':
                        ReservationController.initialize();
                        break;
                    case 'management':
                        ReservationController.loadUserReservations();
                        break;
                    case 'admin':
                        const currentUser = AuthController.getCurrentUser();
                        if (currentUser && currentUser.isAdmin) {
                            AdminControllerInstance.loadAdminData();
                        } else {
                            this.navigateTo('reservation');
                            NotificationService.show('ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™', 'error');
                        }
                        break;
                }
            }
        };

        /**
         * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
         */
        const ModalController = {
            showConfirmModal(reservation) {
                const details = document.getElementById('confirmDetails');
                details.innerHTML = `
                    <p><strong>æ—¥ä»˜:</strong> ${reservation.date}</p>
                    <p><strong>æ™‚é–“:</strong> ${reservation.startTime} ã‹ã‚‰ ${reservation.duration}åˆ†</p>
                    <p><strong>ãƒ–ãƒ¼ã‚¹:</strong> ${reservation.boothName}</p>
                    ${reservation.isOtherCollege ? `<div class="alert alert-info">æ³¨æ„: ä»–ã‚«ãƒ¬ãƒƒã‚¸ã®ãƒ–ãƒ¼ã‚¹ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã—ãŸã€‚</div>` : ''}
                `;
                this.openModal('confirmModal');
            },
            openModal(modalId) { document.getElementById(modalId).style.display = 'block'; },
            closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        };

        /**
         * é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹
         */
        const NotificationService = {
            show(message, type = 'info') {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type}`;
                alertDiv.textContent = message;
                alertDiv.style.cssText = `position: fixed; top: 80px; right: 20px; z-index: 1001;`;
                document.body.appendChild(alertDiv);
                setTimeout(() => alertDiv.remove(), 3000);
            }
        };

        /**
         * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
         */
        const initializeApp = () => {
            const storage = new DataStorage();
            window.AuthController = new AuthenticationController(storage);
            window.ReservationController = new ReservationManagementController(storage);
            window.AdminControllerInstance = new AdminController(storage);
            window.NavigationController = NavigationController;
            window.ModalController = ModalController;
            window.NotificationService = NotificationService;
            
            AuthController.initialize();

            window.onclick = (event) => {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            };
        };

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
# tora7777.github.io
