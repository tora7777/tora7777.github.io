<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬å·¥å­¦é™¢è’²ç”°æ ¡ é¢æ¥ãƒ–ãƒ¼ã‚¹äºˆç´„ã‚·ã‚¹ãƒ†ãƒ  v2.2</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header hidden" id="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">ğŸ¢</div>
                <span>é¢æ¥ãƒ–ãƒ¼ã‚¹äºˆç´„ã‚·ã‚¹ãƒ†ãƒ </span>
            </div>
            <nav>
                <ul class="nav-menu" style="list-style: none; display: flex; gap: 20px;">
                    <li><a href="#" onclick="NavigationController.navigateTo('reservation')" class="nav-link" style="color: white; text-decoration: none;">äºˆç´„</a></li>
                    <li><a href="#" onclick="NavigationController.navigateTo('management')" class="nav-link" style="color: white; text-decoration: none;">äºˆç´„ç®¡ç†</a></li>
                    <li class="hidden" id="adminLink"><a href="#" onclick="NavigationController.navigateTo('admin')" class="nav-link" style="color: white; text-decoration: none;">ç®¡ç†è€…</a></li>
                </ul>
            </nav>
            <div class="user-info" style="display: flex; align-items: center; gap: 10px; color: white;">
                <span id="userEmail"></span>
                <button class="btn btn-secondary" onclick="AuthController.logout()" style="background: #95a5a6; color: white;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>
    </header>

    <main class="main-content">
        
        <div class="page active" id="loginPage">
            <div class="container" style="max-width: 400px; margin-top: 100px;">
                <div class="card">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <h1 style="color: var(--secondary-color); font-size: 2rem;">é¢æ¥ãƒ–ãƒ¼ã‚¹äºˆç´„ã‚·ã‚¹ãƒ†ãƒ </h1>
                        <p style="color: var(--text-secondary);">æ—¥æœ¬å·¥å­¦é™¢è’²ç”°æ ¡ å­¦ç”Ÿå°‚ç”¨</p>
                    </div>
                    
                    <div id="loginForm">
                        <form onsubmit="AuthController.handleLogin(event)">
                            <div class="form-group">
                                <label for="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                <input type="email" id="email" placeholder="k000a0000@g.neec.ac.jp" required>
                            </div>
                            <div class="form-group">
                                <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                                <input type="password" id="password" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%">ãƒ­ã‚°ã‚¤ãƒ³</button>
                        </form>
                        <div style="text-align: center; margin-top: 1rem;">
                            <a href="#" onclick="AuthController.showRegisterForm()" style="color: var(--primary-color);">åˆå›åˆ©ç”¨ã®æ–¹ã¯ã“ã¡ã‚‰</a>
                        </div>
                    </div>

                    <div id="registerForm" class="hidden">
                        <form onsubmit="AuthController.handleRegister(event)">
                            <div class="form-group">
                                <label for="regEmail">å­¦æ ¡ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                <input type="email" id="regEmail" placeholder="k000a0000@g.neec.ac.jp" 
                                       pattern="k[0-9]{3}[a-z][0-9]{4}@g\.neec\.ac\.jp" required>
                            </div>
                            <div class="form-group">
                                <label for="regPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                                <input type="password" id="regPassword" minlength="8" required>
                            </div>
                            <div class="form-group">
                                <label for="regPasswordConfirm">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
                                <input type="password" id="regPasswordConfirm" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%">ç™»éŒ²ã—ã¦èªè¨¼ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡</button>
                        </form>
                        <div style="text-align: center; margin-top: 1rem;">
                            <a href="#" onclick="AuthController.showLoginForm()" style="color: var(--primary-color);">ãƒ­ã‚°ã‚¤ãƒ³ã«æˆ»ã‚‹</a>
                        </div>
                    </div>
                    
                    <div id="verificationMessage" class="hidden alert alert-info" style="margin-top: 1.5rem; text-align: center;">
                        èªè¨¼ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ã‚’ç¢ºèªã—ã€è¨˜è¼‰ã•ã‚ŒãŸãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç™»éŒ²ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚
                    </div>

                </div>
            </div>
        </div>

        <div class="page" id="reservationPage">
            <div class="container">
                <div class="card">
                    <h2 class="card-header">
                        <span>ğŸ“…</span>
                        æ–°è¦äºˆç´„
                    </h2>
                    
                    <div class="auto-assign-info">
                        <p><strong>ãƒ–ãƒ¼ã‚¹è‡ªå‹•å‰²ã‚Šå½“ã¦ã‚·ã‚¹ãƒ†ãƒ ã«ã¤ã„ã¦</strong></p>
                        <p>ã‚·ã‚¹ãƒ†ãƒ ãŒä»¥ä¸‹ã®å„ªå…ˆé †ä½ã§è‡ªå‹•çš„ã«ãƒ–ãƒ¼ã‚¹ã‚’å‰²ã‚Šå½“ã¦ã¾ã™ï¼š</p>
                        <ul>
                            <li>1. æ‰€å±ã‚«ãƒ¬ãƒƒã‚¸ã®å°‚ç”¨ãƒ–ãƒ¼ã‚¹</li>
                            <li>2. å…±é€šåˆ©ç”¨ãƒ–ãƒ¼ã‚¹ï¼ˆ6,7ç•ªï¼‰</li>
                            <li>3. ä½¿ç”¨ç‡ã®ä½ã„ä»–ã‚«ãƒ¬ãƒƒã‚¸ãƒ–ãƒ¼ã‚¹</li>
                        </ul>
                        <p>â€»ä»–ã‚«ãƒ¬ãƒƒã‚¸ã®ãƒ–ãƒ¼ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã¯ã€è©²å½“ã‚«ãƒ¬ãƒƒã‚¸ã®æ‹…å½“è€…ã«é€šçŸ¥ãŒé€ä¿¡ã•ã‚Œã¾ã™</p>
                    </div>
                    
                    <form onsubmit="ReservationController.handleReservation(event)">
                        <div class="form-group">
                            <label for="reservationDate">äºˆç´„æ—¥</label>
                            <input type="date" id="reservationDate" required onchange="ReservationController.updateAvailability()">
                        </div>

                        <div class="form-group">
                            <label>é–‹å§‹æ™‚é–“</label>
                            <div class="time-slot-container">
                                <div class="time-slots" id="timeSlots">
                                    <div class="time-slot-placeholder">æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="duration">åˆ©ç”¨æ™‚é–“</label>
                            <select id="duration">
                                <option value="30">30åˆ†</option>
                                <option value="60" selected>60åˆ†ï¼ˆæ¨™æº–ï¼‰</option>
                                <option value="90">90åˆ†</option>
                                <option value="120">120åˆ†</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="purpose">åˆ©ç”¨ç›®çš„ãƒ»å‚™è€ƒ</label>
                            <textarea id="purpose" rows="3" placeholder="é¢æ¥ã®ç¨®é¡ã€ä¼æ¥­åãªã©"></textarea>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="reminder" style="width: auto;"> 
                                äºˆç´„1æ™‚é–“å‰ã«ãƒªãƒã‚¤ãƒ³ãƒ‰ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹
                            </label>
                        </div>

                        <button type="submit" class="btn btn-primary">äºˆç´„ç¢ºå®š</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="page" id="managementPage">
            <div class="container">
                <div class="card">
                    <h2 class="card-header">
                        <span>ğŸ“‹</span>
                        äºˆç´„ç®¡ç†
                    </h2>
                    <div id="userReservations">
                        </div>
                </div>
            </div>
        </div>

        <div class="page" id="adminPage">
            <div class="container">
                <div class="card">
                    <h2 class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span>âš™ï¸</span>
                            ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                        </div>
                         <button class="btn btn-primary" onclick="AdminControllerInstance.openAddModal()">æ–°è¦äºˆç´„ä½œæˆ</button>
                    </h2>
                    
                    <div class="admin-stats">
                        <div class="stat-card">
                            <div class="stat-label">æœ¬æ—¥ã®äºˆç´„</div>
                            <div class="stat-number" id="totalReservations">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">ç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
                            <div class="stat-number" id="totalUsers">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">ç¨¼åƒç‡</div>
                            <div class="stat-number" id="utilizationRate">0%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">åˆ©ç”¨å¯èƒ½ãƒ–ãƒ¼ã‚¹</div>
                            <div class="stat-number" id="activeBooths">7</div>
                        </div>
                    </div>

                    <h3 style="margin-top: 2rem; margin-bottom: 1rem;">å…¨äºˆç´„ä¸€è¦§</h3>

                    <div class="filter-controls">
                        <input type="text" id="emailFilter" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§æ¤œç´¢" onkeyup="AdminControllerInstance.loadAllReservations()">
                        <input type="date" id="dateFilter" onchange="AdminControllerInstance.loadAllReservations()">
                        <button class="btn btn-secondary" onclick="AdminControllerInstance.clearFilters()">ã‚¯ãƒªã‚¢</button>
                    </div>

                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color);">äºˆç´„ID</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color);">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color);">ãƒ–ãƒ¼ã‚¹</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color);">æ—¥æ™‚</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color);">æ™‚é–“</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color);">ã‚«ãƒ¬ãƒƒã‚¸</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color);">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="adminReservationsList">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 1.5rem;">äºˆç´„ç¢ºèª</h2>
            <div id="confirmDetails"></div>
            <div style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-secondary" onclick="ModalController.closeModal('confirmModal')" style="background: #95a5a6; color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="ReservationController.confirmReservation()">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <div id="adminAddEditModal" class="modal">
        <div class="modal-content">
            <h2 id="adminModalTitle" style="margin-bottom: 1.5rem;">æ–°è¦äºˆç´„ä½œæˆ</h2>
            <form id="adminReservationForm" onsubmit="AdminControllerInstance.saveReservation(event)">
                <input type="hidden" id="adminReservationId">
                <div class="form-group">
                    <label for="adminStudentEmail">å­¦ç”Ÿãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="adminStudentEmail" required>
                </div>
                <div class="form-group">
                    <label for="adminDate">æ—¥ä»˜</label>
                    <input type="date" id="adminDate" required>
                </div>
                <div class="form-group">
                    <label for="adminTime">é–‹å§‹æ™‚é–“</label>
                    <input type="time" id="adminTime" step="600" required>
                </div>
                <div class="form-group">
                    <label for="adminDuration">åˆ©ç”¨æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
                    <input type="number" id="adminDuration" value="60" step="10" required>
                </div>
                <div class="form-group">
                    <label for="adminBoothId">ãƒ–ãƒ¼ã‚¹</label>
                    <select id="adminBoothId" required>
                        </select>
                </div>
                 <div class="form-group">
                    <label for="adminPurpose">ç›®çš„</label>
                    <textarea id="adminPurpose" rows="2"></textarea>
                </div>
                <div style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="ModalController.closeModal('adminAddEditModal')" style="background: #95a5a6; color: white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- EmailJS SDK -->
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <!-- â˜…â˜…â˜… Firebase SDK ã®è¿½åŠ ã¨åˆæœŸåŒ– (Authãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ ) â˜…â˜…â˜… -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { 
            getAuth, onAuthStateChanged, createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, signOut, sendEmailVerification 
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, getDocs, doc, setDoc, query, where, updateDoc, deleteDoc,
            getDoc 
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        
        // 1. Firebase Configã®å®šç¾©
        const firebaseConfig = {
            apiKey: "AIzaSyCncQkyA2vMDfGgYaqfp4dNEOpNd2e4kTc", // ã”è‡ªèº«ã®APIã‚­ãƒ¼ã«ç½®ãæ›ãˆã¦ãã ã•ã„
            authDomain: "k-hommapj.firebaseapp.com",
            projectId: "k-hommapj",
            storageBucket: "k-hommapj.appspot.com", // .firebasestorage.app ã‹ã‚‰å¤‰æ›´
            messagingSenderId: "548197666135",
            appId: "1:548197666135:web:bfdc4880c69722f18a0212",
        };

        // 2. Firebaseã®åˆæœŸåŒ–ã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°åŒ–
        window.firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(window.firebaseApp);
        window.auth = getAuth(window.firebaseApp); // â˜… Authã®åˆæœŸåŒ–
        
        // 3. Firestore & Auth ã®ä¸»è¦ãªé–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾© (app.jsã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚)
        window.collection = collection;
        window.getDocs = getDocs;
        window.doc = doc;
        window.setDoc = setDoc;
        window.query = query;
        window.where = where;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.getDoc = getDoc; 
        
        // â˜… Authé–¢é€£ã®é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
        window.onAuthStateChanged = onAuthStateChanged;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.sendEmailVerification = sendEmailVerification;
    </script>
    <!-- app.js ã®èª­ã¿è¾¼ã¿ -->
    <script src="app.js"></script>
</body>
</html>
