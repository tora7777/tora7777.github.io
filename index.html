<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日本工学院蒲田校 面接ブース予約システム v2.2</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header hidden" id="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">🏢</div>
                <span>面接ブース予約システム</span>
            </div>
            <nav>
                <ul class="nav-menu" style="list-style: none; display: flex; gap: 20px;">
                    <li><a href="#" onclick="NavigationController.navigateTo('reservation')" class="nav-link" style="color: white; text-decoration: none;">予約</a></li>
                    <li><a href="#" onclick="NavigationController.navigateTo('management')" class="nav-link" style="color: white; text-decoration: none;">予約管理</a></li>
                    <li class="hidden" id="adminLink"><a href="#" onclick="NavigationController.navigateTo('admin')" class="nav-link" style="color: white; text-decoration: none;">管理者</a></li>
                </ul>
            </nav>
            <div class="user-info" style="display: flex; align-items: center; gap: 10px; color: white;">
                <span id="userEmail"></span>
                <button class="btn btn-secondary" onclick="AuthController.logout()" style="background: #95a5a6; color: white;">ログアウト</button>
            </div>
        </div>
    </header>

    <main class="main-content">
        
        <div class="page active" id="loginPage">
            <div class="container" style="max-width: 400px; margin-top: 100px;">
                <div class="card">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <h1 style="color: var(--secondary-color); font-size: 2rem;">面接ブース予約システム</h1>
                        <p style="color: var(--text-secondary);">日本工学院蒲田校 学生専用</p>
                    </div>
                    
                    <div id="loginForm">
                        <form onsubmit="AuthController.handleLogin(event)">
                            <div class="form-group">
                                <label for="email">メールアドレス</label>
                                <input type="email" id="email" placeholder="k000a0000@g.neec.ac.jp" required>
                            </div>
                            <div class="form-group">
                                <label for="password">パスワード</label>
                                <input type="password" id="password" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%">ログイン</button>
                        </form>
                        <div style="text-align: center; margin-top: 1rem;">
                            <a href="#" onclick="AuthController.showRegisterForm()" style="color: var(--primary-color);">初回利用の方はこちら</a>
                        </div>
                    </div>

                    <div id="registerForm" class="hidden">
                        <form onsubmit="AuthController.handleRegister(event)">
                            <div class="form-group">
                                <label for="regEmail">学校メールアドレス</label>
                                <input type="email" id="regEmail" placeholder="k000a0000@g.neec.ac.jp" 
                                       pattern="k[0-9]{3}[a-z][0-9]{4}@g\.neec\.ac\.jp" required>
                            </div>
                            <div class="form-group">
                                <label for="regPassword">パスワード</label>
                                <input type="password" id="regPassword" minlength="8" required>
                            </div>
                            <div class="form-group">
                                <label for="regPasswordConfirm">パスワード（確認）</label>
                                <input type="password" id="regPasswordConfirm" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%">登録して認証メールを送信</button>
                        </form>
                        <div style="text-align: center; margin-top: 1rem;">
                            <a href="#" onclick="AuthController.showLoginForm()" style="color: var(--primary-color);">ログインに戻る</a>
                        </div>
                    </div>
                    
                    <div id="verificationMessage" class="hidden alert alert-info" style="margin-top: 1.5rem; text-align: center;">
                        認証メールを送信しました。メールボックスを確認し、記載されたリンクをクリックして登録を完了してください。
                    </div>

                </div>
            </div>
        </div>

        <div class="page" id="reservationPage">
            <div class="container">
                <div class="card">
                    <h2 class="card-header">
                        <span>📅</span>
                        新規予約
                    </h2>
                    
                    <div class="auto-assign-info">
                        <p><strong>ブース自動割り当てシステムについて</strong></p>
                        <p>システムが以下の優先順位で自動的にブースを割り当てます：</p>
                        <ul>
                            <li>1. 所属カレッジの専用ブース</li>
                            <li>2. 共通利用ブース（6,7番）</li>
                            <li>3. 使用率の低い他カレッジブース</li>
                        </ul>
                        <p>※他カレッジのブースを利用する場合は、該当カレッジの担当者に通知が送信されます</p>
                    </div>
                    
                    <form onsubmit="ReservationController.handleReservation(event)">
                        <div class="form-group">
                            <label for="reservationDate">予約日</label>
                            <input type="date" id="reservationDate" required onchange="ReservationController.updateAvailability()">
                        </div>

                        <div class="form-group">
                            <label>開始時間</label>
                            <div class="time-slot-container">
                                <div class="time-slots" id="timeSlots">
                                    <div class="time-slot-placeholder">日付を選択してください</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="duration">利用時間</label>
                            <select id="duration">
                                <option value="30">30分</option>
                                <option value="60" selected>60分（標準）</option>
                                <option value="90">90分</option>
                                <option value="120">120分</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="purpose">利用目的・備考</label>
                            <textarea id="purpose" rows="3" placeholder="面接の種類、企業名など"></textarea>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="reminder" style="width: auto;"> 
                                予約1時間前にリマインドメールを送信する
                            </label>
                        </div>

                        <button type="submit" class="btn btn-primary">予約確定</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="page" id="managementPage">
            <div class="container">
                <div class="card">
                    <h2 class="card-header">
                        <span>📋</span>
                        予約管理
                    </h2>
                    <div id="userReservations">
                        </div>
                </div>
            </div>
        </div>

        <div class="page" id="adminPage">
            <div class="container">
                <div class="card">
                    <h2 class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span>⚙️</span>
                            管理者ダッシュボード
                        </div>
                         <button class="btn btn-primary" onclick="AdminControllerInstance.openAddModal()">新規予約作成</button>
                    </h2>
                    
                    <div class="admin-stats">
                        <div class="stat-card">
                            <div class="stat-label">本日の予約</div>
                            <div class="stat-number" id="totalReservations">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">登録ユーザー</div>
                            <div class="stat-number" id="totalUsers">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">稼働率</div>
                            <div class="stat-number" id="utilizationRate">0%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">利用可能ブース</div>
                            <div class="stat-number" id="activeBooths">7</div>
                        </div>
                    </div>

                    <h3 style="margin-top: 2rem; margin-bottom: 1rem;">全予約一覧</h3>

                    <div class="filter-controls">
                        <input type="text" id="emailFilter" placeholder="メールアドレスで検索" onkeyup="AdminControllerInstance.loadAllReservations()">
                        <input type="date" id="dateFilter" onchange="AdminControllerInstance.loadAllReservations()">
                        <button class="btn btn-secondary" onclick="AdminControllerInstance.clearFilters()">クリア</button>
                    </div>

                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color);">予約ID</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color);">メールアドレス</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color);">ブース</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color);">日時</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color);">時間</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color);">カレッジ</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border-color);">操作</th>
                                </tr>
                            </thead>
                            <tbody id="adminReservationsList">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 1.5rem;">予約確認</h2>
            <div id="confirmDetails"></div>
            <div style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-secondary" onclick="ModalController.closeModal('confirmModal')" style="background: #95a5a6; color: white;">キャンセル</button>
                <button class="btn btn-primary" onclick="ReservationController.confirmReservation()">確定</button>
            </div>
        </div>
    </div>

    <div id="adminAddEditModal" class="modal">
        <div class="modal-content">
            <h2 id="adminModalTitle" style="margin-bottom: 1.5rem;">新規予約作成</h2>
            <form id="adminReservationForm" onsubmit="AdminControllerInstance.saveReservation(event)">
                <input type="hidden" id="adminReservationId">
                <div class="form-group">
                    <label for="adminStudentEmail">学生メールアドレス</label>
                    <input type="email" id="adminStudentEmail" required>
                </div>
                <div class="form-group">
                    <label for="adminDate">日付</label>
                    <input type="date" id="adminDate" required>
                </div>
                <div class="form-group">
                    <label for="adminTime">開始時間</label>
                    <input type="time" id="adminTime" step="600" required>
                </div>
                <div class="form-group">
                    <label for="adminDuration">利用時間（分）</label>
                    <input type="number" id="adminDuration" value="60" step="10" required>
                </div>
                <div class="form-group">
                    <label for="adminBoothId">ブース</label>
                    <select id="adminBoothId" required>
                        </select>
                </div>
                 <div class="form-group">
                    <label for="adminPurpose">目的</label>
                    <textarea id="adminPurpose" rows="2"></textarea>
                </div>
                <div style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="ModalController.closeModal('adminAddEditModal')" style="background: #95a5a6; color: white;">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- EmailJS SDK -->
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <!-- ★★★ Firebase SDK の追加と初期化 (Authモジュール追加) ★★★ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { 
            getAuth, onAuthStateChanged, createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, signOut, sendEmailVerification 
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, getDocs, doc, setDoc, query, where, updateDoc, deleteDoc,
            getDoc 
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        
        // 1. Firebase Configの定義
        const firebaseConfig = {
            apiKey: "AIzaSyCncQkyA2vMDfGgYaqfp4dNEOpNd2e4kTc", // ご自身のAPIキーに置き換えてください
            authDomain: "k-hommapj.firebaseapp.com",
            projectId: "k-hommapj",
            storageBucket: "k-hommapj.appspot.com", // .firebasestorage.app から変更
            messagingSenderId: "548197666135",
            appId: "1:548197666135:web:bfdc4880c69722f18a0212",
        };

        // 2. Firebaseの初期化とグローバル変数化
        window.firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(window.firebaseApp);
        window.auth = getAuth(window.firebaseApp); // ★ Authの初期化
        
        // 3. Firestore & Auth の主要な関数をグローバルに定義 (app.jsからアクセスするため)
        window.collection = collection;
        window.getDocs = getDocs;
        window.doc = doc;
        window.setDoc = setDoc;
        window.query = query;
        window.where = where;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.getDoc = getDoc; 
        
        // ★ Auth関連の関数をグローバル化
        window.onAuthStateChanged = onAuthStateChanged;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.sendEmailVerification = sendEmailVerification;
    </script>
    <!-- app.js の読み込み -->
    <script src="app.js"></script>
</body>
</html>
